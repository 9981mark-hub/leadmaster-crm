<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeadMaster - Supabase ë§ˆì´ê·¸ë ˆì´ì…˜</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: #fff;
        }

        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 24px;
        }

        .subtitle {
            text-align: center;
            color: #94a3b8;
            margin-bottom: 30px;
        }

        .status {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
        }

        .status-line {
            margin: 5px 0;
        }

        .success {
            color: #4ade80;
        }

        .error {
            color: #f87171;
        }

        .info {
            color: #60a5fa;
        }

        button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .primary {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
        }

        .primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }

        .primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .progress {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            height: 20px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-bar {
            background: linear-gradient(90deg, #4ade80, #22d3ee);
            height: 100%;
            width: 0%;
            transition: width 0.3s;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .stat {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #4ade80;
        }

        .stat-label {
            font-size: 12px;
            color: #94a3b8;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸš€ Supabase ë§ˆì´ê·¸ë ˆì´ì…˜</h1>
        <p class="subtitle">Google Sheets â†’ Supabase ë°ì´í„° ì´ì „</p>

        <div class="stats">
            <div class="stat">
                <div class="stat-value" id="totalCount">-</div>
                <div class="stat-label">ì „ì²´ ì¼€ì´ìŠ¤</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="migratedCount">0</div>
                <div class="stat-label">ë§ˆì´ê·¸ë ˆì´ì…˜ë¨</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="errorCount">0</div>
                <div class="stat-label">ì˜¤ë¥˜</div>
            </div>
        </div>

        <div class="progress">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <div class="status" id="status">
            <div class="status-line info">ë§ˆì´ê·¸ë ˆì´ì…˜ ì¤€ë¹„ ì™„ë£Œ</div>
            <div class="status-line">ì‹œì‘ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</div>
        </div>

        <button id="startBtn" class="primary" onclick="startMigration()">
            ğŸ“¦ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘
        </button>
        <button class="secondary" onclick="window.location.href='/'">
            â† LeadMasterë¡œ ëŒì•„ê°€ê¸°
        </button>
    </div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

        // Supabase ì„¤ì •
        const SUPABASE_URL = 'https://cenksfblktflfurxjmtv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNlbmtzZmJsa3RmbGZ1cnhqbXR2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzNzcyNTksImV4cCI6MjA4NDk1MzI1OX0.CNXTi73sjRem7FJqEMHZMxkwcpwagU3xzPpFELrUYRw';

        // Google Apps Script URL (LeadMasterì—ì„œ ì‚¬ìš© ì¤‘ì¸ URL)
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyv68G12Kd0g8RThZGpXToV2m_PjN7IsaBXwzDkPvA1TqsgFTIjQFuuC0G0_Xitsxm8/exec';

        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let totalCases = [];
        let migratedCount = 0;
        let errorCount = 0;

        function log(message, type = '') {
            const status = document.getElementById('status');
            const line = document.createElement('div');
            line.className = `status-line ${type}`;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            status.appendChild(line);
            status.scrollTop = status.scrollHeight;
        }

        function updateProgress() {
            const total = totalCases.length || 1;
            const progress = ((migratedCount + errorCount) / total) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            document.getElementById('migratedCount').textContent = migratedCount;
            document.getElementById('errorCount').textContent = errorCount;
        }

        // camelCase to snake_case ë³€í™˜
        function caseToDb(c) {
            return {
                case_id: c.caseId,
                created_at: c.createdAt,
                updated_at: c.updatedAt,
                status: c.status,
                secondary_status: c.secondaryStatus || null,
                is_viewed: c.isViewed || false,
                deleted_at: c.deletedAt || null,
                customer_name: c.customerName,
                phone: c.phone,
                birth: c.birth || null,
                gender: c.gender || 'ë‚¨',
                region: c.region || null,
                manager_name: c.managerName,
                partner_id: c.partnerId,
                case_type: c.caseType || 'ê°œì¸íšŒìƒ',
                inbound_path: c.inboundPath,
                pre_info: c.preInfo || null,
                history_type: c.historyType || 'ì—†ìŒ',
                job_types: c.jobTypes || [],
                income_net: c.incomeNet || 0,
                income_details: c.incomeDetails || {},
                insurance4: c.insurance4 || 'ë¯¸ê°€ì…',
                housing_type: c.housingType || 'ì›”ì„¸',
                housing_detail: c.housingDetail || 'ê¸°íƒ€',
                rent_contractor: c.rentContractor || null,
                deposit: c.deposit || 0,
                deposit_loan_amount: c.depositLoanAmount || 0,
                rent: c.rent || 0,
                own_house_price: c.ownHousePrice || 0,
                own_house_loan: c.ownHouseLoan || 0,
                own_house_owner: c.ownHouseOwner || null,
                credit_card_use: c.creditCardUse || null,
                credit_card_amount: c.creditCardAmount || 0,
                loan_monthly_pay: c.loanMonthlyPay || 0,
                marital_status: c.maritalStatus || 'ë¯¸í˜¼',
                children_count: c.childrenCount || 0,
                contract_at: c.contractAt || null,
                contract_fee: c.contractFee || 0,
                installment_months: c.installmentMonths || null,
                use_capital: c.useCapital || false,
                assets: c.assets || [],
                credit_loan: c.creditLoan || [],
                special_memo: c.specialMemo || [],
                reminders: c.reminders || [],
                recordings: c.recordings || [],
                deposit_history: c.depositHistory || [],
                status_logs: c.statusLogs || [],
                missed_call_count: c.missedCallCount || 0,
                last_missed_call_at: c.lastMissedCallAt || null,
                ai_summary: c.aiSummary || null,
                formatted_summary: c.formattedSummary || null
            };
        }

        async function fetchFromGoogleSheets() {
            log('Google Sheetsì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ëŠ” ì¤‘...', 'info');
            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?type=leads&_t=${Date.now()}`);
                const data = await response.json();
                if (Array.isArray(data)) {
                    return data;
                }
                throw new Error('Invalid response');
            } catch (err) {
                log(`Google Sheets ì˜¤ë¥˜: ${err.message}`, 'error');
                return [];
            }
        }

        async function migrateCase(caseData) {
            try {
                const dbCase = caseToDb(caseData);
                const { error } = await supabase
                    .from('cases')
                    .upsert([dbCase], { onConflict: 'case_id' });

                if (error) throw error;
                migratedCount++;
                return true;
            } catch (err) {
                errorCount++;
                log(`ì˜¤ë¥˜ (${caseData.customerName || caseData.caseId}): ${err.message}`, 'error');
                return false;
            }
        }

        window.startMigration = async function () {
            const btn = document.getElementById('startBtn');
            btn.disabled = true;
            btn.textContent = 'â³ ë§ˆì´ê·¸ë ˆì´ì…˜ ì¤‘...';

            log('ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘...', 'info');

            // 1. Google Sheetsì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            totalCases = await fetchFromGoogleSheets();
            document.getElementById('totalCount').textContent = totalCases.length;

            if (totalCases.length === 0) {
                log('ë§ˆì´ê·¸ë ˆì´ì…˜í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                btn.disabled = false;
                btn.textContent = 'ğŸ“¦ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘';
                return;
            }

            log(`${totalCases.length}ê±´ì˜ ì¼€ì´ìŠ¤ë¥¼ ë§ˆì´ê·¸ë ˆì´ì…˜í•©ë‹ˆë‹¤...`, 'info');

            // 2. ë°°ì¹˜ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ (5ê°œì”©)
            const batchSize = 5;
            for (let i = 0; i < totalCases.length; i += batchSize) {
                const batch = totalCases.slice(i, i + batchSize);
                await Promise.all(batch.map(migrateCase));
                updateProgress();

                // ì§„í–‰ìƒí™© ë¡œê·¸
                if ((i + batchSize) % 20 === 0 || i + batchSize >= totalCases.length) {
                    log(`ì§„í–‰: ${Math.min(i + batchSize, totalCases.length)} / ${totalCases.length}`, 'info');
                }
            }

            // 3. ì™„ë£Œ
            log(`âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ! ${migratedCount}ê±´ ì„±ê³µ, ${errorCount}ê±´ ì˜¤ë¥˜`, 'success');
            btn.textContent = 'âœ… ì™„ë£Œ!';
        };
    </script>
</body>

</html>