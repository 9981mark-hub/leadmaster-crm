const f=()=>{const o=localStorage.getItem("google_api_key");return o||""},w=o=>{localStorage.setItem("google_api_key",o)},y=()=>!!f(),T=async o=>{var a,e,m;const r=f();if(!r)return{success:!1,rawText:"",parsed:{date:null,amount:null,storeName:null,items:[]},error:"API 키가 설정되지 않았습니다. 설정에서 Google API 키를 입력해주세요."};try{const n=o.includes(",")?o.split(",")[1]:o,i=await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${r}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({requests:[{image:{content:n},features:[{type:"TEXT_DETECTION",maxResults:1}]}]})});if(!i.ok){const d=await i.json();throw new Error(((a=d.error)==null?void 0:a.message)||"Vision API 요청 실패")}const c=(m=(e=(await i.json()).responses)==null?void 0:e[0])==null?void 0:m.textAnnotations;if(!c||c.length===0)return{success:!1,rawText:"",parsed:{date:null,amount:null,storeName:null,items:[]},error:"이미지에서 텍스트를 찾을 수 없습니다."};const s=c[0].description||"",t=h(s);return{success:!0,rawText:s,parsed:t}}catch(n){return console.error("Vision API Error:",n),{success:!1,rawText:"",parsed:{date:null,amount:null,storeName:null,items:[]},error:n instanceof Error?n.message:"OCR 처리 중 오류가 발생했습니다."}}},h=o=>{const r=o.split(`
`).map(s=>s.trim()).filter(Boolean);let a=null,e=null,m=null;const n=[],i=[/(\d{4})[.\-/년](\d{1,2})[.\-/월](\d{1,2})일?/,/(\d{2})[.\-/](\d{1,2})[.\-/](\d{1,2})/],l=[/(?:합\s*계|총\s*액|결제\s*금액|판매\s*금액|총\s*금액|TOTAL|Total)\s*[:\s]?\s*([\d,]+)\s*원?/i,/(?:카드|신용|체크|현금)\s*결제\s*[:\s]?\s*([\d,]+)\s*원?/i,/([\d,]+)\s*원\s*$/m];for(const s of r){if(!a)for(const t of i){const d=s.match(t);if(d){let u=d[1];const p=d[2].padStart(2,"0"),g=d[3].padStart(2,"0");u.length===2&&(u="20"+u),a=`${u}-${p}-${g}`;break}}for(const t of l){const d=s.match(t);if(d){const u=parseInt(d[1].replace(/,/g,""));(!e||u>e)&&(e=u)}}}if(r.length>0)for(let s=0;s<Math.min(5,r.length);s++){const t=r[s];if(t.length>=2&&!/^\d+$/.test(t)&&!/^[=\-*]+$/.test(t)&&!/^\d{2,3}[-)]?\d{3,4}[-]?\d{4}$/.test(t)&&!/^서울|부산|대구|인천|광주|대전|울산|세종|경기|강원|충북|충남|전북|전남|경북|경남|제주/.test(t)){m=t;break}}const c=/^(.+?)\s+([\d,]+)\s*원?$/;for(const s of r){const t=s.match(c);t&&t[1].length<30&&n.push(t[1].trim())}return{date:a,amount:e,storeName:m,items:n}},I=o=>new Promise((r,a)=>{const e=new FileReader;e.onload=()=>{typeof e.result=="string"?r(e.result):a(new Error("파일 읽기 실패"))},e.onerror=()=>a(e.error),e.readAsDataURL(o)}),x=(o,r=1024,a=1024)=>new Promise((e,m)=>{const n=new Image;n.onload=()=>{let{width:i,height:l}=n;if(i>r||l>a){const t=Math.min(r/i,a/l);i=Math.floor(i*t),l=Math.floor(l*t)}const c=document.createElement("canvas");c.width=i,c.height=l;const s=c.getContext("2d");if(!s){m(new Error("Canvas context 생성 실패"));return}s.drawImage(n,0,0,i,l),e(c.toDataURL("image/jpeg",.85))},n.onerror=()=>m(new Error("이미지 로드 실패")),n.src=o});export{T as analyzeReceiptImage,y as hasGoogleApiKey,I as imageToBase64,h as parseReceiptText,x as resizeImage,w as setGoogleApiKey};
